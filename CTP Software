Reference: 
RSNA CTP Documentation:
https://mircwiki.rsna.org/index.php?title=MIRC_CTP

1.	Install CTP
Double-click the “CTP-installer.jar” provided in the folder “CHORUS_metadata_deid_instruction/CTP/” and choose a directory in which to install CTP software.

2.	Configure CTP launcher 
A pre-configured file, “config.xml”, is provided in the CTP folder. This file defines the server setup and processing pipeline, which consists of five stages.

  (1)	Pipeline overview:
  •	ArchiveImportService: 
  The ArchiveImportService walks the directory tree of a static archive and imports the files it finds. The files are copied from the archive and placed in a separate directory before being passed down the pipeline. When the files have been processed, they are deleted from the directory to which they were copied, but they remain in the archive. To restart the process from the beginning or run a new import, clear the stage's root directory.
  For real-time file import, refer to the DirectoryImportService documentation here: DirectoryImportService - MIRC CTP Wiki
  •	DicomFilter
  The DicomFilter, defined in the provided script file “DicomFilter.script”, filters out DICOM files that do not belong to the following modalities: 
    o	X-ray: computed radiography (CR), digital radiography (DX), mammography (MG)
    o	CT
    o	MR
  •	IDMap:
  The IDMap constructs map tables for UID elements, AccessionNumber, and PatientID. Note: In this project, only UID mapping is relevant, as PatientID and AccessionNumber are not replaced.
  •	DicomAnonymizer
  The DicomAnonymizer de-identify metadata within DICOM files. The DicomAnonymizer is defined in the provided script file (“DicomAnonymizer_chorus.script”). In the script, PatientID, AccessionNumber, and selected date tags (Table 1) will remain unchanged.
  •	DirectoryStorageService
  The DirectoryStorageService stores the de-identified DICOM files in the following folder structure defined in the provided configuration file: 
  Modality / PatientID / AccessionNumber / SeriesDescription

  (2)	Configuration procedure:
  (a)	Configuration file (“config.xml”) modification: 
    •	Modify “maxThreads” or “port” attributes of the server if necessary.
    •	Modify pipeline “root” to store processing results as an absolute directory. 
    •	Modify ArchiveImportService “treeRoot” as an absolute directory where your input DICOM data is stored. Modify the value of “minAge” if it is not appropriate. 
  (b) Configuration deployment
    •	Replace the default “config.xml” under the root directory of the installed CTP software with your modified version. 
    •	Copy the provided script “DicomAnonymizer_chorus.script” and “DicomFilter.script” into the subfolder “scripts”.

  (3)	Output folder
    (1)	Output folder structure
    There will be two subfolders in the defined pipeline root:
    o	quarantines: Holds isolated DICOM files that could not be processed due to errors or validation failures.
    o	roots: Contains all stage files, including:
      •	De-identified DICOM files stored by the DirectoryStorageService stage.
      •	ID mapping files (_map.db and _map.lg) generated by the IDMap stage.

  (2)	View IDMap
  The IDMap can be viewed or downloaded as CSV files through the CTP Home Page, as described in the appendix A of this manual.
  For headless Linux systems where accessing the CTP Home Page is not possible, a Java class file (ExportIDMap.class) provided in the CTP folder can be used to convert the mapping database files (_map.db and _map.lg) to CSV format.
    Steps to convert IDMap files:
      o	Download the required JAR file:
      wget https://repo1.maven.org/maven2/jdbm/jdbm/1.0/jdbm-1.0.jar
      o	Run the code using the following command:
      java -cp .:jdbm-1.0.jar ExportIDMap __map <map_file_directory> <output_directory>
      Note: replace "<map_file_directory>" and "<output_directory>" with your actual directories.

3.	Run CTP
Double-click “Launcher.jar” in the root directory of the software to start the launcher.  In the “General” tab, click “Start” to start data processing. To stop data processing, just click “Stop”. 
![Screenshot of CTP Software](/assets/images/CTP software screenshot.png)


Testing
A “test_sample” folder is provided, containing files and directories intended for reference, testing, or evaluation. The test samples are sourced from the MIMIC dataset, which has already been de-identified. Consequently, the metadata tags included are significantly fewer than those found in typical clinical DICOM images. For additional details, please refer to Appendix B.
